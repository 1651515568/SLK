import React, { useState, useEffect } from 'react'
import { Card, Table, Tag, Button, Space, Row, Col, Statistic, Progress, Input, Select, Modal, Descriptions, Alert, message } from 'antd'
import { 
  BugOutlined, 
  PlayCircleOutlined, 
  PauseCircleOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
  EyeOutlined,
  SearchOutlined,
  ReloadOutlined,
  InfoCircleOutlined
} from '@ant-design/icons'
import ReactECharts from 'echarts-for-react'
import { Vulnerability, ScanTask } from '@/types'
import { generateMockVulnerabilities, generateMockScanTasks } from '@/utils/mockData'

const VulnerabilityManagement: React.FC = () => {
  const [vulnerabilities, setVulnerabilities] = useState<Vulnerability[]>([])
  const [scanTasks, setScanTasks] = useState<ScanTask[]>([])
  const [searchText, setSearchText] = useState('')
  const [severityFilter, setSeverityFilter] = useState<string>('all')
  
  // 详情弹窗状态
  const [vulnerabilityModalVisible, setVulnerabilityModalVisible] = useState(false)
  const [scanTaskModalVisible, setScanTaskModalVisible] = useState(false)
  const [selectedVulnerability, setSelectedVulnerability] = useState<Vulnerability | null>(null)
  const [selectedScanTask, setSelectedScanTask] = useState<ScanTask | null>(null)

  // 处理扫描任务详情查看
  const handleViewScanTask = (record: ScanTask) => {
    setSelectedScanTask(record)
    setScanTaskModalVisible(true)
  }

  // 处理漏洞详情查看
  const handleViewVulnerability = (record: Vulnerability) => {
    setSelectedVulnerability(record)
    setVulnerabilityModalVisible(true)
  }

  // 处理漏洞修复
  const handleFixVulnerability = (record: Vulnerability) => {
    console.log('修复漏洞:', record)
    message.success(`开始修复漏洞: ${record.cveId}`)
  }

  // 处理扫描任务启动
  const handleStartScanTask = (record: ScanTask) => {
    console.log('启动扫描任务:', record)
    message.success(`启动扫描任务: ${record.name}`)
  }

  // 处理扫描任务暂停
  const handlePauseScanTask = (record: ScanTask) => {
    console.log('暂停扫描任务:', record)
    message.info(`暂停扫描任务: ${record.name}`)
  }

  useEffect(() => {
    loadData()
  }, [])

  const loadData = () => {
    setVulnerabilities(generateMockVulnerabilities())
    setScanTasks(generateMockScanTasks())
  }

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case 'low': return 'green'
      case 'medium': return 'orange'
      case 'high': return 'red'
      case 'critical': return 'magenta'
      default: return 'default'
    }
  }

  const getSeverityText = (severity: string) => {
    switch (severity) {
      case 'low': return '低危'
      case 'medium': return '中危'
      case 'high': return '高危'
      case 'critical': return '严重'
      default: return severity
    }
  }

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'open': return 'red'
      case 'in_progress': return 'orange'
      case 'resolved': return 'green'
      case 'accepted': return 'blue'
      default: return 'default'
    }
  }

  const getStatusText = (status: string) => {
    switch (status) {
      case 'open': return '待处理'
      case 'in_progress': return '处理中'
      case 'resolved': return '已解决'
      case 'accepted': return '已接受'
      default: return status
    }
  }

  const getScanStatusColor = (status: string) => {
    switch (status) {
      case 'pending': return 'orange'
      case 'running': return 'blue'
      case 'completed': return 'green'
      case 'failed': return 'red'
      default: return 'default'
    }
  }

  const getScanStatusText = (status: string) => {
    switch (status) {
      case 'pending': return '等待中'
      case 'running': return '运行中'
      case 'completed': return '已完成'
      case 'failed': return '失败'
      default: return status
    }
  }

  // 漏洞分布图表配置
  const getVulnerabilityDistributionOption = () => ({
    title: {
      text: '漏洞严重程度分布',
      left: 'center'
    },
    tooltip: {
      trigger: 'item'
    },
    series: [{
      type: 'pie',
      radius: '60%',
      data: [
        { value: vulnerabilities.filter(v => v.severity === 'critical').length, name: '严重' },
        { value: vulnerabilities.filter(v => v.severity === 'high').length, name: '高危' },
        { value: vulnerabilities.filter(v => v.severity === 'medium').length, name: '中危' },
        { value: vulnerabilities.filter(v => v.severity === 'low').length, name: '低危' }
      ],
      emphasis: {
        itemStyle: {
          shadowBlur: 10,
          shadowOffsetX: 0,
          shadowColor: 'rgba(0, 0, 0, 0.5)'
        }
      }
    }]
  })

  // 扫描任务趋势图表配置
  const getScanTrendOption = () => ({
    title: {
      text: '扫描任务趋势',
      left: 'center'
    },
    tooltip: {
      trigger: 'axis'
    },
    legend: {
      data: ['发现漏洞数', '完成任务数'],
      top: 30
    },
    xAxis: {
      type: 'category',
      data: ['12-20', '12-21', '12-22', '12-23', '12-24', '12-25', '12-26']
    },
    yAxis: {
      type: 'value',
      name: '数量'
    },
    series: [
      {
        name: '发现漏洞数',
        type: 'bar',
        data: [8, 12, 15, 10, 6, 9, 3],
        itemStyle: {
          color: '#f5222d'
        }
      },
      {
        name: '完成任务数',
        type: 'line',
        data: [2, 3, 4, 2, 1, 2, 1],
        smooth: true,
        itemStyle: {
          color: '#52c41a'
        }
      }
    ]
  })

  const vulnerabilityColumns = [
    {
      title: 'CVE ID',
      dataIndex: 'cveId',
      key: 'cveId',
      width: 150,
    },
    {
      title: '漏洞标题',
      dataIndex: 'title',
      key: 'title',
      width: 300,
    },
    {
      title: '严重程度',
      dataIndex: 'severity',
      key: 'severity',
      width: 100,
      render: (severity: string) => (
        <Tag color={getSeverityColor(severity)}>
          {getSeverityText(severity)}
        </Tag>
      )
    },
    {
      title: 'CVSS评分',
      dataIndex: 'cvssScore',
      key: 'cvssScore',
      width: 100,
      render: (score: number) => (
        <span className={score >= 7 ? 'text-red-600 font-semibold' : score >= 4 ? 'text-orange-600' : 'text-green-600'}>
          {score}
        </span>
      )
    },
    {
      title: '受影响设备',
      dataIndex: 'affectedDevices',
      key: 'affectedDevices',
      width: 150,
      render: (devices: string[]) => (
        <span>{devices.length} 个设备</span>
      )
    },
    {
      title: '发现日期',
      dataIndex: 'discoveryDate',
      key: 'discoveryDate',
      width: 120,
    },
    {
      title: '状态',
      dataIndex: 'status',
      key: 'status',
      width: 100,
      render: (status: string) => (
        <Tag color={getStatusColor(status)}>
          {getStatusText(status)}
        </Tag>
      )
    },
    {
      title: '操作',
      key: 'action',
      width: 120,
      render: (record: Vulnerability) => (
        <Space>
          <Button
            type="link"
            icon={<EyeOutlined />}
            size="small"
            onClick={() => handleViewVulnerability(record)}
          >
            详情
          </Button>
          <Button
            type="link"
            size="small"
            disabled={record.status === 'resolved'}
            onClick={() => handleFixVulnerability(record)}
          >
            修复
          </Button>
        </Space>
      )
    }
  ]

  const scanTaskColumns = [
    {
      title: '任务名称',
      dataIndex: 'name',
      key: 'name',
      width: 200,
    },
    {
      title: '扫描类型',
      dataIndex: 'scanType',
      key: 'scanType',
      width: 100,
      render: (type: string) => {
        const typeMap = {
          'quick': { text: '快速', color: 'blue' },
          'comprehensive': { text: '全面', color: 'green' },
          'custom': { text: '自定义', color: 'orange' }
        }
        const config = (typeMap as any)[type] || { text: type, color: 'default' }
        return <Tag color={config.color}>{config.text}</Tag>
      }
    },
    {
      title: '状态',
      dataIndex: 'status',
      key: 'status',
      width: 100,
      render: (status: string) => (
        <Tag color={getScanStatusColor(status)} icon={
          status === 'running' ? <PlayCircleOutlined spin /> : 
          status === 'completed' ? <CheckCircleOutlined /> : 
          status === 'failed' ? <CloseCircleOutlined /> : <PauseCircleOutlined />
        }>
          {getScanStatusText(status)}
        </Tag>
      )
    },
    {
      title: '进度',
      dataIndex: 'progress',
      key: 'progress',
      width: 150,
      render: (progress: number) => (
        <Progress percent={progress} size="small" />
      )
    },
    {
      title: '发现漏洞',
      dataIndex: 'vulnerabilitiesFound',
      key: 'vulnerabilitiesFound',
      width: 100,
    },
    {
      title: '开始时间',
      dataIndex: 'startTime',
      key: 'startTime',
      width: 160,
    },
    {
      title: '结束时间',
      dataIndex: 'endTime',
      key: 'endTime',
      width: 160,
      render: (endTime: string) => endTime || '-'
    },
    {
      title: '操作',
      key: 'action',
      width: 120,
      render: (record: ScanTask) => (
        <Space>
          <Button
            type="link"
            icon={<EyeOutlined />}
            size="small"
            onClick={() => handleViewScanTask(record)}
          >
            查看
          </Button>
          {record.status === 'pending' && (
            <Button
              type="link"
              icon={<PlayCircleOutlined />}
              size="small"
              onClick={() => handleStartScanTask(record)}
            >
              启动
            </Button>
          )}
          {record.status === 'running' && (
            <Button
              type="link"
              icon={<PauseCircleOutlined />}
              size="small"
              onClick={() => handlePauseScanTask(record)}
            >
              暂停
            </Button>
          )}
        </Space>
      )
    }
  ]

  // 过滤漏洞数据
  const filteredVulnerabilities = vulnerabilities.filter(vuln => {
    const matchesSearch = !searchText || 
      vuln.cveId.toLowerCase().includes(searchText.toLowerCase()) ||
      vuln.title.toLowerCase().includes(searchText.toLowerCase())
    
    const matchesSeverity = severityFilter === 'all' || vuln.severity === severityFilter
    
    return matchesSearch && matchesSeverity
  })

  return (
    <div className="space-y-6">
      {/* 漏洞统计卡片 */}
      <Row gutter={[16, 16]}>
        <Col xs={24} sm={12} lg={6}>
          <Card className="security-stat-card">
            <Statistic
              title="总漏洞数"
              value={vulnerabilities.length}
              valueStyle={{ color: '#f5222d' }}
              prefix={<BugOutlined />}
            />
          </Card>
        </Col>
        <Col xs={24} sm={12} lg={6}>
          <Card className="security-stat-card">
            <Statistic
              title="严重漏洞"
              value={vulnerabilities.filter(v => v.severity === 'critical').length}
              valueStyle={{ color: '#f5222d' }}
              prefix={<BugOutlined />}
            />
          </Card>
        </Col>
        <Col xs={24} sm={12} lg={6}>
          <Card className="security-stat-card">
            <Statistic
              title="待处理漏洞"
              value={vulnerabilities.filter(v => v.status === 'open').length}
              valueStyle={{ color: '#fa8c16' }}
              prefix={<PauseCircleOutlined />}
            />
          </Card>
        </Col>
        <Col xs={24} sm={12} lg={6}>
          <Card className="security-stat-card">
            <Statistic
              title="已解决漏洞"
              value={vulnerabilities.filter(v => v.status === 'resolved').length}
              valueStyle={{ color: '#52c41a' }}
              prefix={<CheckCircleOutlined />}
            />
          </Card>
        </Col>
      </Row>

      {/* 图表区域 */}
      <Row gutter={[16, 16]}>
        <Col xs={24} lg={12}>
          <Card title="漏洞严重程度分布" className="security-card">
            <ReactECharts 
              option={getVulnerabilityDistributionOption()} 
              style={{ height: '300px' }}
            />
          </Card>
        </Col>
        <Col xs={24} lg={12}>
          <Card title="扫描任务趋势" className="security-card">
            <ReactECharts 
              option={getScanTrendOption()} 
              style={{ height: '300px' }}
            />
          </Card>
        </Col>
      </Row>

      {/* 扫描任务管理 */}
      <Card 
        title="扫描任务管理" 
        className="security-card"
        extra={
          <Button
            type="primary"
            icon={<PlayCircleOutlined />}
          >
            新建扫描任务
          </Button>
        }
      >
        <Table
          columns={scanTaskColumns}
          dataSource={scanTasks}
          rowKey="id"
          pagination={{
            total: scanTasks.length,
            pageSize: 5,
            showSizeChanger: true,
            showQuickJumper: true,
            showTotal: (total) => `共 ${total} 条记录`,
          }}
          scroll={{ x: 1200 }}
        />
      </Card>

      {/* 漏洞列表 */}
      <Card 
        title="漏洞列表" 
        className="security-card"
        extra={
          <Space>
            <Button
              icon={<ReloadOutlined />}
              onClick={loadData}
            >
              刷新
            </Button>
          </Space>
        }
      >
        {/* 搜索和过滤 */}
        <Row gutter={[16, 16]} className="mb-4">
          <Col xs={24} sm={12}>
            <Input
              placeholder="搜索CVE ID或漏洞标题"
              prefix={<SearchOutlined />}
              value={searchText}
              onChange={(e) => setSearchText(e.target.value)}
            />
          </Col>
          <Col xs={24} sm={12}>
            <Select
              placeholder="严重程度"
              style={{ width: '100%' }}
              value={severityFilter}
              onChange={setSeverityFilter}
            >
              <Select.Option value="all">全部等级</Select.Option>
              <Select.Option value="critical">严重</Select.Option>
              <Select.Option value="high">高危</Select.Option>
              <Select.Option value="medium">中危</Select.Option>
              <Select.Option value="low">低危</Select.Option>
            </Select>
          </Col>
        </Row>

        <Table
          columns={vulnerabilityColumns}
          dataSource={filteredVulnerabilities}
          rowKey="id"
          pagination={{
            total: filteredVulnerabilities.length,
            pageSize: 10,
            showSizeChanger: true,
            showQuickJumper: true,
            showTotal: (total) => `共 ${total} 条记录`,
          }}
          scroll={{ x: 1200 }}
        />
      </Card>

      {/* 修复指南 */}
      <Card title="修复指南" className="security-card">
        <Row gutter={[16, 16]}>
          <Col xs={24} lg={8}>
            <Card size="small" title="严重漏洞修复" className="border-red-200">
              <div className="space-y-2">
                <p className="text-sm text-gray-600">
                  对于CVSS评分≥9.0的严重漏洞，建议：
                </p>
                <ul className="text-sm space-y-1">
                  <li>• 立即应用官方安全补丁</li>
                  <li>• 评估业务影响，制定维护窗口</li>
                  <li>• 实施临时缓解措施</li>
                  <li>• 加强监控和日志记录</li>
                </ul>
              </div>
            </Card>
          </Col>
          <Col xs={24} lg={8}>
            <Card size="small" title="高危漏洞修复" className="border-orange-200">
              <div className="space-y-2">
                <p className="text-sm text-gray-600">
                  对于CVSS评分7.0-8.9的高危漏洞，建议：
                </p>
                <ul className="text-sm space-y-1">
                  <li>• 在48小时内应用安全补丁</li>
                  <li>• 评估漏洞利用可能性</li>
                  <li>• 增强相关系统的监控</li>
                  <li>• 制定应急响应计划</li>
                </ul>
              </div>
            </Card>
          </Col>
          <Col xs={24} lg={8}>
            <Card size="small" title="中低危漏洞修复" className="border-yellow-200">
              <div className="space-y-2">
                <p className="text-sm text-gray-600">
                  对于CVSS评分&lt;7.0的中低危漏洞，建议：
                </p>
                <ul className="text-sm space-y-1">
                  <li>• 在定期维护窗口内修复</li>
                  <li>• 评估业务优先级</li>
                  <li>• 记录修复计划和进度</li>
                  <li>• 定期复测验证修复效果</li>
                </ul>
              </div>
            </Card>
          </Col>
        </Row>
      </Card>
      
      {/* 漏洞详情弹窗 */}
      <Modal
        title="漏洞详情"
        open={vulnerabilityModalVisible}
        onCancel={() => setVulnerabilityModalVisible(false)}
        footer={null}
        width={900}
      >
        {selectedVulnerability && (
          <div className="space-y-4">
            <Alert
              message={`CVE ID: ${selectedVulnerability.cveId}`}
              description={selectedVulnerability.title}
              type={selectedVulnerability.severity === 'critical' ? 'error' : selectedVulnerability.severity === 'high' ? 'warning' : 'info'}
              showIcon
              icon={<InfoCircleOutlined />}
            />
            
            <Descriptions bordered column={2} size="small">
              <Descriptions.Item label="严重程度" span={1}>
                <Tag color={getSeverityColor(selectedVulnerability.severity)}>
                  {getSeverityText(selectedVulnerability.severity)}
                </Tag>
              </Descriptions.Item>
              <Descriptions.Item label="CVSS评分" span={1}>
                <span className={`font-bold ${
                  selectedVulnerability.cvssScore >= 7 ? 'text-red-600' : 
                  selectedVulnerability.cvssScore >= 4 ? 'text-orange-600' : 'text-green-600'
                }`}>
                  {selectedVulnerability.cvssScore}
                </span>
              </Descriptions.Item>
              <Descriptions.Item label="发现日期" span={1}>
                {selectedVulnerability.discoveryDate}
              </Descriptions.Item>
              <Descriptions.Item label="当前状态" span={1}>
                <Tag color={getStatusColor(selectedVulnerability.status)}>
                  {getStatusText(selectedVulnerability.status)}
                </Tag>
              </Descriptions.Item>
              <Descriptions.Item label="受影响设备" span={2}>
                {selectedVulnerability.affectedDevices.length} 个设备
                <div className="mt-2">
                  {selectedVulnerability.affectedDevices.slice(0, 5).map((device, index) => (
                    <Tag key={index} className="mb-1">{device}</Tag>
                  ))}
                  {selectedVulnerability.affectedDevices.length > 5 && (
                    <Tag color="blue">+{selectedVulnerability.affectedDevices.length - 5} 更多</Tag>
                  )}
                </div>
              </Descriptions.Item>
              <Descriptions.Item label="漏洞描述" span={2}>
                <div className="bg-gray-50 p-3 rounded text-sm">
                  {selectedVulnerability.description}
                </div>
              </Descriptions.Item>
              <Descriptions.Item label="修复建议" span={2}>
                <div className="bg-blue-50 p-3 rounded text-sm">
                  {selectedVulnerability.remediation}
                </div>
              </Descriptions.Item>
              <Descriptions.Item label="漏洞利用" span={1}>
                <Tag color={selectedVulnerability.exploitAvailable ? 'red' : 'green'}>
                  {selectedVulnerability.exploitAvailable ? '已发现利用代码' : '暂无利用代码'}
                </Tag>
              </Descriptions.Item>
            </Descriptions>
          </div>
        )}
      </Modal>
      
      {/* 扫描任务详情弹窗 */}
      <Modal
        title="扫描任务详情"
        open={scanTaskModalVisible}
        onCancel={() => setScanTaskModalVisible(false)}
        footer={null}
        width={800}
      >
        {selectedScanTask && (
          <div className="space-y-4">
            <Alert
              message={`任务: ${selectedScanTask.name}`}
              description={`扫描目标: ${selectedScanTask.target.join(', ')}`}
              type={selectedScanTask.status === 'failed' ? 'error' : selectedScanTask.status === 'running' ? 'warning' : 'info'}
              showIcon
              icon={<InfoCircleOutlined />}
            />
            
            <Descriptions bordered column={2} size="small">
              <Descriptions.Item label="任务名称" span={2}>
                {selectedScanTask.name}
              </Descriptions.Item>
              <Descriptions.Item label="扫描类型" span={1}>
                <Tag color={{
                  'quick': 'blue',
                  'comprehensive': 'green',
                  'custom': 'orange'
                }[selectedScanTask.scanType]}>
                  {{'quick': '快速扫描', 'comprehensive': '全面扫描', 'custom': '自定义扫描'}[selectedScanTask.scanType]}
                </Tag>
              </Descriptions.Item>
              <Descriptions.Item label="任务状态" span={1}>
                <Tag color={getScanStatusColor(selectedScanTask.status)}>
                  {getScanStatusText(selectedScanTask.status)}
                </Tag>
              </Descriptions.Item>
              <Descriptions.Item label="扫描进度" span={2}>
                <Progress percent={selectedScanTask.progress} status={selectedScanTask.status === 'failed' ? 'exception' : 'active'} />
              </Descriptions.Item>
              <Descriptions.Item label="开始时间" span={1}>
                {selectedScanTask.startTime}
              </Descriptions.Item>
              <Descriptions.Item label="结束时间" span={1}>
                {selectedScanTask.endTime || '-'}
              </Descriptions.Item>
              <Descriptions.Item label="扫描目标" span={2}>
                <div className="space-y-1">
                  {selectedScanTask.target.map((target, index) => (
                    <Tag key={index}>{target}</Tag>
                  ))}
                </div>
              </Descriptions.Item>
              <Descriptions.Item label="发现漏洞" span={1}>
                <span className="font-bold text-red-600">{selectedScanTask.vulnerabilitiesFound}</span> 个
              </Descriptions.Item>
              <Descriptions.Item label="任务ID" span={1}>
                {selectedScanTask.id}
              </Descriptions.Item>
            </Descriptions>
          </div>
        )}
      </Modal>
    </div>
  )
}

export default VulnerabilityManagement